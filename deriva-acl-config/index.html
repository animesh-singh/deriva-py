<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Configure ACLs (deriva-acl-config) - deriva-py Documentation</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link href="../css/extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Configure ACLs (deriva-acl-config)";
    var mkdocs_page_input_path = "deriva-acl-config.md";
    var mkdocs_page_url = "/deriva-acl-config/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> deriva-py Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">deriva-py Documentation</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">User Docs</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../install/">Installing deriva-py</a>
                </li>
                <li class="">
                    
    <a class="" href="../deriva-download-cli/">Bulk export tool (deriva-download-cli)</a>
                </li>
                <li class="">
                    
    <a class="" href="../deriva-hatrac-cli/">Interact with Hatrac object store (deriva-hatrac-cli)</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Configure ACLs (deriva-acl-config)</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#using-deriva-acl-config-to-configure-acls">Using deriva-acl-config to configure ACLs</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#config-file-format">Config file format</a></li>
        
            <li><a class="toctree-l4" href="#security-considerations">Security Considerations</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../deriva-annotation-config/">Configure annotations (deriva-annotation-config)</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../api/">API Docs</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">deriva-py Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>User Docs &raquo;</li>
        
      
    
    <li>Configure ACLs (deriva-acl-config)</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h3 id="using-deriva-acl-config-to-configure-acls">Using deriva-acl-config to configure ACLs<a class="headerlink" href="#using-deriva-acl-config-to-configure-acls" title="Permanent link">&para;</a></h3>
<p>The <code>deriva-acl-config</code> utility reads a configuration file and uses it to set ACLs for an ermrest catalog (or for a schema or table within that catalog). Usage is:</p>
<p><code>deriva-acl-config</code> [<code>-g</code>|<code>--groups-only</code>] [<code>-n</code>|<code>--dryrun</code>] [<code>-v</code>|<code>--verbose</code>] [<code>-s</code>|<code>--schema</code> schema] [<code>-t</code>|<code>--table</code> table] [<code>--host host</code>] [<code>--config-file</code> config_file] [<code>--credential-file</code> credential_file] catalog</p>
<p>where the required arguments are:</p>
<p><em>catalog</em>: an ermrest catalog number (e.g., 1)</p>
<p><code>--config_file</code> file: the name of a configuration file</p>
<p>Options are:</p>
<p><code>-credential_file</code> file: read credentials from the named <em>file</em> (if not specified, look for credentials maintained by <code>deriva-auth</code>)</p>
<p><code>--groups-only</code>: create and populate a group table (used for dynamic ACLs) based on the contents of the config file</p>
<p><code>--dryrun</code>: do nothing, just print out the catalog schema that would be applied</p>
<p><code>--verbose</code>: verbose, print acls and acl bindings for each object</p>
<p><code>--schema</code> schema: operate only on the named <em>schema</em>, not the whole catalog</p>
<p><code>--table</code> table: operate only on the named <em>table</em>, not the whole catalog (requires the <code>--schema</code> option)</p>
<p><code>--host</code> host: configure the server on the specified <em>host</em> (default <code>localhost</code>)</p>
<h4 id="config-file-format">Config file format<a class="headerlink" href="#config-file-format" title="Permanent link">&para;</a></h4>
<p>The config file is a json file divided into the following stanzas:</p>
<p><code>groups</code>: defines a set of named group lists, which can be used in ACL definitions later in the config file.</p>
<p><code>group_list_table</code>: the schema and table name of a table to populate with the information from the <code>groups</code> stanza, so you can use the same named group lists in both static and dynamic ACLs and maintain them in one place. This table will typically be the last step in most dynamic ACL projections.</p>
<p><code>acl_definitions</code>: static ACL definitions (e.g., "{"write": "consortium", "select": "everyone"}) that can be referred to later on in the config file (in this example, <code>consortium</code> and <code>everyone</code> are group lists defined in the <code>groups</code> stanza).</p>
<p><code>acl_bindings</code>: dynamic ACL definitions</p>
<p><code>catalog_acl</code>: the ACL for the catalog; this will be one of the ACLs defined in the <code>acl_definitions</code> stanza.</p>
<p><code>schema_acls</code>: ACLs for individual schemas. Static ACLs (from <code>acl_definitions</code>) stanza are assigned to schemas.</p>
<p><code>table_acls</code>: ACLs for individual tables. Static ACLs (from <code>acl_definitions</code>) and dynamic ACLs (from <code>acl_bindings</code>) are assigned to tabless.</p>
<p><code>column_acls</code>: ACLs for individual columns. Static ACLs (from <code>acl_definitions</code>) and dynamic ACLs (from <code>acl_bindings</code>) are assigned to columns</p>
<p><code>foreign_key_acls</code>: ACLs for foreign keys. Static ACLs (from <code>acl_definitions</code>) and dynamic ACLs (from <code>acl_bindings</code>) are assigned to foreign keys</p>
<h5 id="the-groups-stanza">The groups stanza<a class="headerlink" href="#the-groups-stanza" title="Permanent link">&para;</a></h5>
<p>The <code>groups</code> stanza is a list of entries of the form </p>
<p>name: [values]</p>
<p>where <em>name</em> is a name that will be used to refer to a set of groups, and <em>values</em> is a list of group entries. The entries can be either the actual group IDs (from webauthn) or names of previously-defined groups. For example:</p>
<pre><code>    &quot;groups&quot; : {
    &quot;empty&quot;: [],
    &quot;public&quot;: [&quot;*&quot;],    
        &quot;isrd-staff&quot;: [&quot;https://auth.globus.org/176baec4-ed26-11e5-8e88-22000ab4b42b&quot;],
        &quot;isrd-systems&quot;: [&quot;https://auth.globus.org/3938e0d0-ed35-11e5-8641-22000ab4b42b&quot;],
        &quot;isrd-testers&quot;: [&quot;https://auth.globus.org/9d596ac6-22b9-11e6-b519-22000aef184d&quot;],
    &quot;isrd-all&quot;: [&quot;isrd-staff&quot;, &quot;isrd-systems&quot;, &quot;isrd-testers&quot;]
    }
</code></pre>

<h5 id="the-group_list_table-stanza">The group_list_table stanza<a class="headerlink" href="#the-group_list_table-stanza" title="Permanent link">&para;</a></h5>
<p>If you're defining dynamic ACLs, at some point you'll probably want a table in your catalog somewhere that maps names to lists of groups. The group_list_table stanza specifies the schema and table name of a table to create for this list of groups. For example:</p>
<pre><code>    &quot;group_list_table&quot; : {&quot;schema&quot; : &quot;_acl_admin&quot;, &quot;table&quot; : &quot;group_lists&quot;}
</code></pre>

<p>This will cause the <code>_acl_admin.group_lists</code> table to be created (if it doesn't already exist) and populated with the information specified in the <code>groups</code> stanza. The <code>name</code> column of the table will be the primary key and will contain group name, and the <code>groups</code> column will be the fully-expanded group list. The example <code>groups</code> stanza above will create this table:</p>
<pre><code>     name     |                                                                                          groups                                                                                          
--------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 isrd-staff   | {https://auth.globus.org/176baec4-ed26-11e5-8e88-22000ab4b42b}
 isrd-testers | {https://auth.globus.org/9d596ac6-22b9-11e6-b519-22000aef184d}
 isrd-systems | {https://auth.globus.org/3938e0d0-ed35-11e5-8641-22000ab4b42b}
 isrd-all     | {https://auth.globus.org/176baec4-ed26-11e5-8e88-22000ab4b42b,https://auth.globus.org/9d596ac6-22b9-11e6-b519-22000aef184d,https://auth.globus.org/3938e0d0-ed35-11e5-8641-22000ab4b42b}
 public       | {*}
 empty        | {}
</code></pre>

<h5 id="the-acl_definitions-stanza">The acl_definitions stanza<a class="headerlink" href="#the-acl_definitions-stanza" title="Permanent link">&para;</a></h5>
<p>This is where you define static ACLs for later use. The syntax is a list of</p>
<p>name: value</p>
<p>entries, where the <em>name</em> is a name you can refer to later, to assign these ACLs to objects, and the <em>value</em> is the ACL itself (which will probably contain references to the groups defined in the <code>groups</code> stanza). For example:</p>
<pre><code>    &quot;acl_definitions&quot; : {
        &quot;unrestricted_read&quot; : {&quot;select&quot; : &quot;public&quot;, &quot;create&quot;: &quot;isrd-systems&quot;, &quot;write&quot;: &quot;isrd-systems&quot;},
        &quot;isrd_read&quot; : {&quot;select&quot; : &quot;isrd-all&quot;, &quot;create&quot;: &quot;isrd-systems&quot;, &quot;write&quot;: &quot;isrd-systems&quot;},
        &quot;secret&quot; : {&quot;select&quot; : &quot;empty&quot;}
     }
</code></pre>

<p>In this example, the <code>unrestricted_read</code> ACL grants read access to everyone and restricts create and write access to the <code>isrd-systems</code> group; the <code>isrd_read</code> ACL is the same,except that it grants read access only to the <code>isrd-all</code> set of groups. Note that this stanza only defines the set of permissions and who they're associated with; by itself, it doesn't apply these ACLs to any object in the catalog.</p>
<h5 id="the-acl_bindings-stanza">The acl_bindings stanza<a class="headerlink" href="#the-acl_bindings-stanza" title="Permanent link">&para;</a></h5>
<p>This is where you define dynamic ACLs for later use. The syntax is a list of</p>
<p>name: value</p>
<p>pairs, where the <em>name</em> is a name you can refer to later, and the <em>value</em> is a dynamic ACL. For example:</p>
<pre><code>    &quot;acl_bindings&quot; : {
    &quot;a_binding&quot; : {
        &quot;scope_acl&quot;: &quot;isrd-staff&quot;,
        &quot;types&quot; : [&quot;select&quot;],
        &quot;projection&quot; : [{&quot;outbound_col&quot; : &quot;allowed_groups&quot;}, &quot;groups&quot;],
        &quot;projection_type&quot; : &quot;acl&quot;
    }
</code></pre>

<p>This defines an ACL binding called <code>a_binding</code>. The syntax of the binding itself is the same as defined in the ermrest ACL docs, with one exception: to specify an outbound foreign key, you can either use ermrest-standard <code>outbound</code> syntax and use the constraint name, or you can use <code>outbound_col</code> and specify the name of a column on which a foreign key is defined. It will also populate the <code>scope_acl</code> based on the referenced group list. For example, if you apply the binding <code>a_binding</code> to this table:</p>
<pre><code>     Column     | Type | Modifiers 
----------------+------+-----------
 my_data        | text | 
 allowed_groups | text | not null
Foreign-key constraints:
    &quot;mytable_allowed_groups_fkey&quot; FOREIGN KEY (allowed_groups) REFERENCES _acl_admin.group_lists(name)
</code></pre>

<p>then the actual ermrest dynamic ACL will be:</p>
<pre><code>        &quot;a_binding&quot; : {
            &quot;scope_acl&quot;: [&quot;https://auth.globus.org/176baec4-ed26-11e5-8e88-22000ab4b42b&quot;],
            &quot;types&quot; : [&quot;select&quot;],
            &quot;projection&quot; : [{&quot;outbound&quot; : &quot;mytable_allowed_groups_fkey&quot;}, &quot;groups&quot;],
            &quot;projection_type&quot; : &quot;acl&quot;
        }
</code></pre>

<p>This can be useful if you want to apply the same dynamic ACL to mutliple tables, since each table's foreign key will have a different name by default.</p>
<h5 id="the-catalog_acls-stanza">The catalog_acls stanza<a class="headerlink" href="#the-catalog_acls-stanza" title="Permanent link">&para;</a></h5>
<p>This is where ACLs for the catalog itself are set. (Note: there's a bootstrapping issue for new catalogs - since this tool uses ermrest, you need to already have permission on the catalog before you can set any new permissions). For example:</p>
<pre><code>    &quot;catalog_acl&quot; : {&quot;acl&quot; : &quot;unrestricted_read&quot;}
</code></pre>

<p>This applies the <code>unrestricted_read</code> ACL defined above to the catalog.</p>
<h5 id="the-schema_acls-stanza">The schema_acls stanza<a class="headerlink" href="#the-schema_acls-stanza" title="Permanent link">&para;</a></h5>
<p>This is where ACLs for schemas are set. The syntax is a list of entries of the form:</p>
<p>{schema_descriptor: value, acl_descriptor: value}</p>
<p>A schema_descriptor is either:</p>
<p><code>"schema":</code> <em>schema_name</em></p>
<p>or</p>
<p><code>"schema_pattern:"</code> <em>regular_expression</em></p>
<p>When setting permissions on a schema:
<em> if an exact <code>schema</code> match is found, the associated ACL is used (and any matching <code>schema_pattern</code> entries are ignored).
</em> If no exact <code>schema</code> match is found and exactly one matching <code>schema_pattern</code> entry is found, then that ACL is used.
* If no exact <code>schema</code> match is found and more than one matching <code>schema_pattern</code> entry is found, then an error is thrown.</p>
<p>An acl descriptor has the form</p>
<p><code>"acl":</code> <em>name_of_acl_defined_earlier</em></p>
<p>or</p>
<p><code>"no_acl": true</code></p>
<p>If an <code>acl</code> is specified, the named static ACL is expanded and applied to the schema. If <code>no_acl</code> is specified, no ACL is applied to the schema (and as a result, it inherits whatever permissions are set by the catalog ACL).</p>
<p>For example:</p>
<pre><code>    &quot;schema_acls&quot; : [
    {&quot;schema&quot; : &quot;Vocabulary&quot;, &quot;no_acl&quot; : &quot;true&quot;},
    {&quot;schema&quot; : &quot;ISRD_Internal&quot;, &quot;acl&quot; : &quot;isrd_read&quot;},
        {&quot;schema_pattern&quot; : &quot;.*&quot;, &quot;acl&quot;: &quot;secret&quot;}
    ]
</code></pre>

<p>This, paired with the catalog_acl stanza above, allows anyone to read the Vocabulary schema and ISRD people to read the "ISRD_Internal". It forbids anyone from reading any other schema in the catalog.</p>
<h5 id="the-table_acls-stanza">The table_acls stanza<a class="headerlink" href="#the-table_acls-stanza" title="Permanent link">&para;</a></h5>
<p>This is where ACLs for tables are set. The syntax is a list of entries of the form:
{schema_descriptor, table_descriptor, [acl_descriptor], [acl_bindings_descriptor]}
A schema descriptor has the same form as in the schema_acls stanza.</p>
<p>A table_descriptor is either:</p>
<p><code>"table":</code> <em>table_name</em></p>
<p>or</p>
<p><code>"table_pattern:"</code> <em>regular_expression</em></p>
<p>Regular expression matching is used:
<em> If an entry with an exact <code>schema</code> and <code>table</code> match is found, the associated ACL is used (and any other matching entries are ignored).
</em> Otherwise, if entry with an exact <code>schema</code> match and exactly one <code>table_pattern</code> match is found, that ACL is used.
<em> Otherwise, if exactly one entry with a <code>schema_pattern</code> and <code>table_pattern</code> match is found, that ACL is used.
</em> If none of the above is true, and multiple matching entries are found, then an error is thrown.</p>
<p>An acl_descriptor is the same as defined above.</p>
<p>An <code>acl_bindings_descriptor</code> has the form:</p>
<p><code>"acl_bindings":</code> [list_of_bindings]`</p>
<p>where <em>list_of_bindings</em> is a list of ACL bindings defined in the acl_bindings stanza.</p>
<h5 id="the-column_acls-stanza">The column_acls stanza<a class="headerlink" href="#the-column_acls-stanza" title="Permanent link">&para;</a></h5>
<p>This is where ACLs for columns are set. The syntax is a list of entries of the form:
{schema_descriptor, table_descriptor, column_descriptor, [acl_descriptor], [acl_bindings_descriptor] [invalidate_bindings_descriptor]}
The schema, table, acl, and acl_bindings descriptors have the same form as above.
The column_descriptor is either:</p>
<p><code>"column":</code> <em>table_name</em></p>
<p>or</p>
<p><code>"column_pattern:"</code> <em>regular_expression</em></p>
<p>Regular expression matching is used:
<em> If an entry with exact <code>schema</code>, <code>table</code>, and <code>column</code> matches is found, the associated ACL is used (and any other matching entries are ignored).
</em> Otherwise, if exactly one entry is found with <code>schema</code>, <code>table</code>, and <code>column</code> matches is found, that ACL is used
* If multiple regular-expression matches are found and no exact match is found, an exception is thrown.</p>
<p>The i<code>nvalidate_bindings</code> descriptor has the form:</p>
<p><code>"invalidate_bindings"</code>: [list_of_bindings]</p>
<p>where <em>list_of_bindings</em> is a list of bindng names to invalidate (i.e., ACL bindings that were defined on the column's table but that should not be applied to the column).</p>
<h5 id="the-foreign_key_acls-stanza">The foreign_key_acls stanza<a class="headerlink" href="#the-foreign_key_acls-stanza" title="Permanent link">&para;</a></h5>
<p>This is where ACLs for foreign keys are set. The syntax is a list of entries of the form:</p>
<p>{schema_descriptor, table_descriptor, fkey_schema_descriptor, fkey_name_descriptor, [acl_descriptor], [acl_bindings_descriptor], [invalidate_bindings_descriptor]}</p>
<p>The schema, table, acl, acl_bindings, and invalidate_bindings descriptors have the same form as above.
The fkey_schema_descriptor is either:</p>
<p><code>"foreign_key_schema":</code> foreign_key_schema_name</p>
<p>or</p>
<p><code>"foreign_key_schema_pattern":</code> regular_expression</p>
<p>The fkey_name_descriptor is either:</p>
<p><code>"foreign_key":</code> foreign_key_name</p>
<p>or</p>
<p><code>"foreign_key_pattern":</code> regular_expression</p>
<p>These specify the foreign key schema and name. As with the column_acls stanza:
<em> If an exact match is found, it's used
</em> If no exact match is found and exactly one regular expression match is found, it's used.
* If no exact match is found and more than one regular expression match is found, an error is thrown.</p>
<h4 id="security-considerations">Security Considerations<a class="headerlink" href="#security-considerations" title="Permanent link">&para;</a></h4>
<p>There's no guarantee of the order in which changes will be applied. For example, if your current state restricts access to a table, like this:</p>
<pre><code>   &quot;table_acls&quot; : [
       {&quot;schema&quot; : &quot;myschema&quot;, &quot;table&quot; : &quot;mytable&quot;, &quot;acl&quot;: &quot;restricted_access&quot;}
   ]
</code></pre>

<p>and you decide to change to a configuration that restricts access only to one sensitive column in that table:</p>
<pre><code>   &quot;table_acls&quot; : [
       {&quot;schema&quot; : &quot;myschema&quot;, &quot;table&quot; : &quot;mytable&quot;, &quot;acl&quot;: &quot;open_access&quot;}
   ],
   &quot;column_acls&quot; : [
       {&quot;schema&quot; : &quot;myschema&quot;, &quot;table&quot; : &quot;mytable&quot;, &quot;column&quot; : &quot;sensitive_column&quot;, &quot;acl&quot;: &quot;restricted_access&quot;}
   ]

</code></pre>

<p>then it's possible that the change to the table ACL will occur before the change to the column ACL, temporarily exposing the table and all its columns. The solution is to run <code>acl_config</code> in two passes, first adding the new restrictions and then removing the old ones.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../deriva-annotation-config/" class="btn btn-neutral float-right" title="Configure annotations (deriva-annotation-config)">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../deriva-hatrac-cli/" class="btn btn-neutral" title="Interact with Hatrac object store (deriva-hatrac-cli)"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright &copy; 2018 <a href="http://github.com/informatics-isi-edu/deriva-py">deriva-py Project</a>.</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../deriva-hatrac-cli/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../deriva-annotation-config/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
